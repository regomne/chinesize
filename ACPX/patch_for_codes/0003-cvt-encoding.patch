From 320a01e19f821f6363ef3d74c813f155c937ffd5 Mon Sep 17 00:00:00 2001
From: regomne <fallingsunz@gmail.com>
Date: Sat, 31 Aug 2019 12:01:50 +0800
Subject: [PATCH 3/4] cvt encoding

---
 misc/text.c | 86 ++++++++++++++++++++++++++---------------------------
 1 file changed, 43 insertions(+), 43 deletions(-)

diff --git a/misc/text.c b/misc/text.c
index f102685..c04cba8 100644
--- a/misc/text.c
+++ b/misc/text.c
@@ -28,7 +28,7 @@ TAG tag;
 uchar tag_buf[4096];
 
 //===========================================================================
-// tHg
+// フォントのO定
 //===========================================================================
 void init_default_font(int font_id, int weight)
 {
@@ -47,7 +47,7 @@ void init_default_font(int font_id, int weight)
 	}
 }
 //===========================================================================
-// ^O
+// タグの取得
 //===========================================================================
 uchar* get_tag(uchar* text)
 {
@@ -100,7 +100,7 @@ uchar* get_tag(uchar* text)
 	return text;
 }
 //===========================================================================
-// l
+// 数の取得
 //===========================================================================
 int get_num(uchar* text, int value)
 {
@@ -117,7 +117,7 @@ int get_num(uchar* text, int value)
 	return value;
 }
 //===========================================================================
-// R[h
+// 文字コ`ドの取得
 //===========================================================================
 ushort get_chr(uchar** pp)
 {
@@ -136,7 +136,7 @@ ushort get_chr(uchar** pp)
 	return ch;
 }
 //===========================================================================
-// R[hi[
+// 文字コ`ドの格{
 //===========================================================================
 void set_chr(uchar** pp, ushort ch)
 {
@@ -150,7 +150,7 @@ void set_chr(uchar** pp, ushort ch)
 	}
 }
 //===========================================================================
-// Q
+// g体参照のQ
 //===========================================================================
 int entity_reference(uchar* text)
 {
@@ -186,7 +186,7 @@ int entity_reference(uchar* text)
 	return code;
 }
 //===========================================================================
-// ^OteLXg`
+// タグ付きテキストの描画
 //===========================================================================
 typedef struct{
 	uchar*		text;
@@ -199,8 +199,8 @@ typedef struct{
 
 extern int check_bracket(int ch)
 {
-	uchar* bracket_l = "egikmoqsuwy";
-	uchar* bracket_r = "fhjlnprtvxz";
+	uchar* bracket_l = "‘“（〔［｛〈《「『【";
+	uchar* bracket_r = "’”）〕］｝〉》」』】";
 	uchar* pch = strchr(bracket_l, ch);
 	if(pch != NULL){
 		pch = &bracket_r[pch - bracket_l];
@@ -211,10 +211,10 @@ extern int check_bracket(int ch)
 
 void hyphenation_text(MESSAGE* mes)
 {
-	static uchar* head_weak = " .:;?!ABCDFGJK]fhjlnprtvxz";
-	static uchar* head = ".:;?!ABCDFGJK]fhjlnprtvxz"
-						"@BDFHb[HI";
-	static uchar* tail = "egikmoqsuwy";
+	static uchar* head_weak = " .:;?!、。，．：；ab\’”）〕］｝〉》」』】";
+	static uchar* head = ".:;?!、。，．：；ab\’”）〕］｝〉》」』】"
+						"ぁぃぅぇぉゃゅょっァィゥェォッャュョヮヵヶ`？！";
+	static uchar* tail = "‘“（〔［｛〈《「『【";
 	static int level = 0;
 
 	static LINEDAT bank[256];
@@ -494,7 +494,7 @@ void hyphenation_text(MESSAGE* mes)
 	}
 }
 //===========================================================================
-// tHg
+// 画像フォントの初期化
 //===========================================================================
 #define FONT_CACHE_SIZE		32
 
@@ -513,7 +513,7 @@ void init_font_cache()
 	free_font_cache();
 }
 //===========================================================================
-// tHgn
+// 画像フォントの後始末
 //===========================================================================
 void free_font_cache()
 {
@@ -524,7 +524,7 @@ void free_font_cache()
 	font_cache_count = 0;
 }
 //===========================================================================
-// tHg[h
+// 画像フォントのロ`ド
 //===========================================================================
 FONT_CACHE* load_font_code(uchar face, uchar code)
 {
@@ -559,7 +559,7 @@ FONT_CACHE* load_font_code(uchar face, uchar code)
 	return &font_cache[0];
 }
 //===========================================================================
-// tHg`
+// 画像フォントの描画
 //===========================================================================
 void put_char(int page, int x, int y, uchar* ch, int size, int face)
 {
@@ -597,7 +597,7 @@ void put_char(int page, int x, int y, uchar* ch, int size, int face)
 	smooth(page, &rc0, font->page, &rc1, -1);
 }
 //===========================================================================
-// tHg`
+// フォント描画
 //===========================================================================
 void draw_char(MESSAGE* mes, int x, int y, int ch, bool ruby)
 {
@@ -621,9 +621,9 @@ void draw_char(MESSAGE* mes, int x, int y, int ch, bool ruby)
 		}
 		if(ruby_change & 0x01){
 			if(mes->ruby_type == FT_GOTHIC){
-				strcpy(ruby_font.name, "lr SVbN");
+				strcpy(ruby_font.name, "ＭＳ ゴシック");
 			}else if(mes->ruby_type == FT_MINCHO){
-				strcpy(ruby_font.name, "lr ");
+				strcpy(ruby_font.name, "ＭＳ 明朝");
 			}else if(mes->ruby_type == FT_USER){
 				strcpy(ruby_font.name, user_font_name);
 			}
@@ -652,9 +652,9 @@ void draw_char(MESSAGE* mes, int x, int y, int ch, bool ruby)
 		}
 		if(font_change & 0x01){
 			if(mes->font_type == FT_GOTHIC){
-				strcpy(text_font.name, "lr SVbN");
+				strcpy(text_font.name, "ＭＳ ゴシック");
 			}else if(mes->font_type == FT_MINCHO){
-				strcpy(text_font.name, "lr ");
+				strcpy(text_font.name, "ＭＳ 明朝");
 			}else if(mes->font_type == FT_USER){
 				strcpy(text_font.name, user_font_name);
 			}
@@ -730,7 +730,7 @@ void draw_char(MESSAGE* mes, int x, int y, int ch, bool ruby)
 	}
 }
 //===========================================================================
-// ruby^O
+// rubyタグ
 //===========================================================================
 void process_ruby(MESSAGE* mes)
 {
@@ -755,9 +755,9 @@ void process_ruby(MESSAGE* mes)
 		if(!strcmp(tag.attrib[i], "text")){
 			strcpy(text, tag.value[i]);
 		}else if(!strcmp(tag.attrib[i], "type")){
-			if(!strcmp(tag.value[i], "SVbN")){
+			if(!strcmp(tag.value[i], "ゴシック")){
 				mes->ruby_type = FT_GOTHIC;
-			}else if(!strcmp(tag.value[i], "")){
+			}else if(!strcmp(tag.value[i], "明朝")){
 				mes->ruby_type = FT_MINCHO;
 			}else{
 				mes->ruby_type = default_font_id;
@@ -827,7 +827,7 @@ void process_ruby(MESSAGE* mes)
 	mes->ruby_drop_col = ruby_drop_col;
 }
 //===========================================================================
-// font^O
+// fontタグ
 //===========================================================================
 void process_font(MESSAGE* mes)
 {
@@ -842,9 +842,9 @@ void process_font(MESSAGE* mes)
 
 	for(i = 0; i < tag.count; i++){
 		if(!strcmp(tag.attrib[i], "type")){
-			if(!strcmp(tag.value[i], "SVbN")){
+			if(!strcmp(tag.value[i], "ゴシック")){
 				mes->font_type = FT_GOTHIC;
-			}else if(!strcmp(tag.value[i], "")){
+			}else if(!strcmp(tag.value[i], "明朝")){
 				mes->font_type = FT_MINCHO;
 			}else{
 				mes->font_type = default_font_id;
@@ -889,7 +889,7 @@ void process_font(MESSAGE* mes)
 	mes->font_drop_col = font_drop_col;
 }
 //===========================================================================
-// img^O
+// imgタグ
 //===========================================================================
 void process_img(MESSAGE* mes)
 {
@@ -1024,7 +1024,7 @@ void process_img(MESSAGE* mes)
 	}
 }
 //===========================================================================
-// em^O
+// emタグ
 //===========================================================================
 void process_em(MESSAGE* mes)
 {
@@ -1041,7 +1041,7 @@ void process_em(MESSAGE* mes)
 	mes->flag = flag;
 }
 //===========================================================================
-// key^O
+// keyタグ
 //===========================================================================
 void process_key(MESSAGE* mes)
 {
@@ -1061,7 +1061,7 @@ void process_key(MESSAGE* mes)
 	}
 }
 //===========================================================================
-// P`
+// １文字描画
 //===========================================================================
 void process_char(MESSAGE* mes)
 {
@@ -1107,7 +1107,7 @@ void process_char(MESSAGE* mes)
 		w = mes->font_size / 2;
 	}
 
-//	if(ch != '@' && ch != ' '){
+//	if(ch != '　' && ch != ' '){
 		x = mes->margin_left + mes->x;
 		if(mes->align == 1){
 			x += mes->space[mes->line_count] / 2;
@@ -1133,7 +1133,7 @@ void process_char(MESSAGE* mes)
 	mes->x += w + mes->column_space;
 }
 //===========================================================================
-// 
+// 文字列解析
 //===========================================================================
 void process_text(MESSAGE* mes)
 {
@@ -1276,7 +1276,7 @@ void process_text(MESSAGE* mes)
 	}
 }
 //===========================================================================
-// W[
+// モジュ`ル初期化
 //===========================================================================
 extern void init_text_lib()
 {
@@ -1296,7 +1296,7 @@ extern void init_text_lib()
 	}
 }
 //===========================================================================
-// W[
+// モジュ`ル解放
 //===========================================================================
 extern void free_text_lib()
 {
@@ -1312,7 +1312,7 @@ extern void free_text_lib()
 	}
 }
 //===========================================================================
-// tHgobt@TCY
+// フォントバッファのリサイズ
 //===========================================================================
 extern void resize_text_buffer(int width, int height)
 {
@@ -1338,7 +1338,7 @@ extern void resize_text_buffer(int width, int height)
 	}
 }
 //===========================================================================
-// `
+// 文字列の描画
 //===========================================================================
 extern int print(MESSAGE* pmes)
 {
@@ -1381,7 +1381,7 @@ extern int print(MESSAGE* pmes)
 	return text_info_count;
 }
 //===========================================================================
-// tHg
+// フォントの初期化
 //===========================================================================
 extern void init_font(int size, uint col, uint edge, uint drop)
 {
@@ -1403,7 +1403,7 @@ extern void init_font(int size, uint col, uint edge, uint drop)
 	mess.bracket = -1;
 }
 //===========================================================================
-// `
+// 文字列の描画
 //===========================================================================
 extern void draw_text(int page, int x, int y, uchar* text)
 {
@@ -1414,7 +1414,7 @@ extern void draw_text(int page, int x, int y, uchar* text)
 	print(&mess);
 }
 //===========================================================================
-// `
+// 描画欷稳〉
 //===========================================================================
 extern void get_text_rect(RECT* prc)
 {
@@ -1428,7 +1428,7 @@ extern void get_text_rect(RECT* prc)
 	}
 }
 //===========================================================================
-// (Q)
+// 文字列のQ(g体参照→特殊文字)
 //===========================================================================
 extern void decode_entities(uchar* dest, uchar* src)
 {
@@ -1462,7 +1462,7 @@ extern void decode_entities(uchar* dest, uchar* src)
 	*dest = '\0';
 }
 //===========================================================================
-// (Q)
+// 文字列のQ(特殊文字→g体参照)
 //===========================================================================
 extern void encode_entities(uchar* dest, uchar* src)
 {
-- 
2.17.0.windows.1

